<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¹¸é‹å¤§æŠ½çå·¥å…·</title>
    <!-- å¼•å…¥å½©å¸¶ç‰¹æ•ˆåº« -->
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <style>
        :root {
            --primary: #4f46e5;
            --primary-hover: #4338ca;
            --bg: #f3f4f6;
            --card-bg: #ffffff;
            --text: #1f2937;
            --border: #e5e7eb;
        }

        body {
            font-family: 'Segoe UI', Microsoft JhengHei, sans-serif;
            background-color: var(--bg);
            color: var(--text);
            margin: 0;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
        }

        .container {
            width: 100%;
            max-width: 1200px;
            display: grid;
            grid-template-columns: 1fr 2fr;
            gap: 20px;
        }

        @media (max-width: 768px) {
            .container {
                grid-template-columns: 1fr;
            }
        }

        /* å¡ç‰‡æ¨£å¼ */
        .card {
            background: var(--card-bg);
            border-radius: 12px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        /* æ¨™é¡Œå€åŸŸ */
        .header {
            width: 100%;
            text-align: center;
            margin-bottom: 20px;
        }

        #eventTitle {
            font-size: 2.5rem;
            font-weight: bold;
            color: var(--primary);
            border: none;
            background: transparent;
            text-align: center;
            width: 100%;
            outline: none;
            border-bottom: 2px dashed transparent;
            transition: border 0.3s;
        }

        #eventTitle:focus {
            border-bottom-color: var(--primary);
        }

        /* è¼¸å…¥å€åŸŸ */
        label {
            font-weight: 600;
            font-size: 0.9rem;
            margin-bottom: 5px;
            display: block;
        }

        textarea {
            width: 100%;
            height: 200px;
            padding: 10px;
            border: 1px solid var(--border);
            border-radius: 8px;
            resize: vertical;
            box-sizing: border-box;
            font-family: inherit;
        }

        input[type="text"], input[type="number"], select {
            width: 100%;
            padding: 10px;
            border: 1px solid var(--border);
            border-radius: 8px;
            box-sizing: border-box;
            font-size: 1rem;
        }

        .control-group {
            display: flex;
            gap: 10px;
        }

        .control-group > div {
            flex: 1;
        }

        /* æŒ‰éˆ• */
        button {
            background-color: var(--primary);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            transition: background 0.2s;
            width: 100%;
        }

        button:hover {
            background-color: var(--primary-hover);
        }

        button:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }

        button.secondary {
            background-color: #9ca3af;
        }
        
        button.secondary:hover {
            background-color: #6b7280;
        }

        button.danger {
            background-color: #ef4444;
        }

        button.danger:hover {
            background-color: #dc2626;
        }

        /* æŠ½ççµæœå€åŸŸ */
        .result-area {
            min-height: 400px;
            position: relative;
        }

        .current-draw-box {
            text-align: center;
            padding: 20px;
            background: #eef2ff;
            border-radius: 8px;
            margin-bottom: 20px;
            border: 2px solid var(--primary);
        }

        .current-draw-box h3 {
            margin: 0 0 10px 0;
            color: #666;
        }

        .big-winner {
            font-size: 3rem;
            font-weight: bold;
            color: var(--primary);
            min-height: 60px;
            animation: popIn 0.3s ease-out;
        }

        .history-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 10px;
            max-height: 400px;
            overflow-y: auto;
        }

        .winner-tag {
            background: white;
            border: 1px solid var(--border);
            padding: 10px;
            border-radius: 6px;
            text-align: center;
            font-weight: 500;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            animation: slideUp 0.3s ease-out;
        }

        .winner-tag span {
            display: block;
            font-size: 0.8rem;
            color: #666;
            margin-bottom: 4px;
        }

        .stats {
            margin-top: 10px;
            font-size: 0.9rem;
            color: #666;
            display: flex;
            justify-content: space-between;
        }

        /* å‹•ç•« */
        @keyframes popIn {
            0% { transform: scale(0.5); opacity: 0; }
            100% { transform: scale(1); opacity: 1; }
        }

        @keyframes slideUp {
            0% { transform: translateY(20px); opacity: 0; }
            100% { transform: translateY(0); opacity: 1; }
        }

        .hidden {
            display: none;
        }
    </style>
</head>
<body>

    <div class="header">
        <input type="text" id="eventTitle" value="ğŸ‰ å…¬å¸å¹´åº¦å¹¸é‹å¤§æŠ½ç ğŸ‰" placeholder="é»æ“Šç·¨è¼¯æ´»å‹•åç¨±">
    </div>

    <div class="container">
        <!-- å·¦å´è¨­å®šå€ -->
        <div class="card">
            <h2>âš™ï¸ æŠ½çè¨­å®š</h2>
            
            <div>
                <label for="names">åƒèˆ‡åå–® (ä¸€è¡Œä¸€å€‹åå­—)</label>
                <textarea id="names" placeholder="å¼µä¸‰&#10;æå››&#10;ç‹äº”&#10;..."></textarea>
                <div class="stats">
                    <span id="totalCount">ç¸½äººæ•¸: 0</span>
                    <span id="poolCount">å‰©é¤˜äººæ•¸: 0</span>
                </div>
            </div>

            <div class="control-group">
                <div>
                    <label for="prizeName">çé …åç¨±</label>
                    <input type="text" id="prizeName" value="ç‰¹ç">
                </div>
                <div>
                    <label for="prizeCount">æŠ½çäººæ•¸</label>
                    <input type="number" id="prizeCount" value="1" min="1">
                </div>
            </div>

            <div>
                <label for="drawMode">æŠ½çæ–¹å¼</label>
                <select id="drawMode">
                    <option value="batch">ä¸€æ¬¡æŠ½å‡ºæ‰€æœ‰å¾—çè€…</option>
                    <option value="single">ä¸€å€‹ä¸€å€‹æ…¢æ…¢æŠ½ (åˆºæ¿€æ¨¡å¼)</option>
                </select>
            </div>

            <div class="control-group">
                <button onclick="startDraw()" id="btnStart">é–‹å§‹æŠ½ç</button>
                <button class="secondary hidden" onclick="drawNext()" id="btnNext">æŠ½ä¸‹ä¸€ä½</button>
            </div>
            
            <button class="danger" onclick="resetData()" style="margin-top: 10px;">é‡ç½®æ‰€æœ‰æ•¸æ“š</button>
        </div>

        <!-- å³å´çµæœå€ -->
        <div class="card result-area">
            <h2>ğŸ† å¾—çåå–®</h2>
            
            <!-- ç›®å‰æ­£åœ¨æŠ½çš„å±•ç¤ºå€ -->
            <div id="currentDrawArea" class="current-draw-box hidden">
                <h3 id="currentPrizeLabel">æ­£åœ¨æŠ½å‡º...</h3>
                <div id="bigWinnerDisplay" class="big-winner">???</div>
            </div>

            <!-- æ­·å²ç´€éŒ„ -->
            <div id="winnerList" class="history-list">
                <!-- å¾—çè€…å¡ç‰‡æœƒåŠ åœ¨é€™è£¡ -->
            </div>
        </div>
    </div>

    <script>
        // å…¨å±€è®Šæ•¸
        let namePool = [];
        let drawnNames = new Set();
        let isDrawing = false;
        
        // å–®æŠ½æ¨¡å¼è®Šæ•¸
        let singleModeQueue = [];
        let currentSinglePrize = "";

        // åˆå§‹åŒ–ç›£è½
        document.getElementById('names').addEventListener('input', updateStats);
        
        function updateStats() {
            const text = document.getElementById('names').value;
            // éæ¿¾ç©ºè¡Œ
            const allNames = text.split('\n').map(n => n.trim()).filter(n => n);
            
            // æ›´æ–°ç¸½æ±  (æ’é™¤å·²ä¸­ççš„)
            // å¦‚æœé‚„æ²’é–‹å§‹æŠ½ï¼Œå°±é‡ç½® pool
            // é€™è£¡ç‚ºäº†ç°¡å–®ï¼Œæ¯æ¬¡ç·¨è¼¯éƒ½è¦–ç‚ºé‡ç½® pool ä½†ä¿ç•™å·²ä¸­çåå–®é‚è¼¯æ¯”è¼ƒè¤‡é›œ
            // ç°¡å–®é‚è¼¯ï¼šå¾ textarea è®€å–æ‰€æœ‰åå­—ï¼Œéæ¿¾æ‰å·²ä¸­ççš„ï¼Œå½¢æˆç›®å‰çš„ pool
            
            const total = allNames.length;
            
            // è¨ˆç®—å‰©é¤˜æ± 
            // é€™è£¡æˆ‘å€‘å‡è¨­ textarea æ°¸é æ˜¯å®Œæ•´çš„åå–®
            // å¯¦éš›æŠ½çæ™‚æœƒæª¢æŸ¥æ˜¯å¦åœ¨ drawnNames ä¸­
            const remaining = allNames.filter(n => !drawnNames.has(n)).length;

            document.getElementById('totalCount').innerText = `ç¸½äººæ•¸: ${total}`;
            document.getElementById('poolCount').innerText = `å¯æŠ½äººæ•¸: ${remaining}`;
        }

        function getPool() {
            const text = document.getElementById('names').value;
            const allNames = text.split('\n').map(n => n.trim()).filter(n => n);
            return allNames.filter(n => !drawnNames.has(n));
        }

        function startDraw() {
            const pool = getPool();
            const prizeName = document.getElementById('prizeName').value || "ç¥ç§˜çé …";
            const countInput = document.getElementById('prizeCount').value;
            const count = parseInt(countInput, 10);
            const mode = document.getElementById('drawMode').value;

            if (pool.length === 0) {
                alert("åå–®ç‚ºç©ºæˆ–æ‰€æœ‰äººçš†å·²ä¸­çï¼");
                return;
            }
            if (count <= 0) {
                alert("æŠ½çäººæ•¸å¿…é ˆå¤§æ–¼ 0");
                return;
            }
            if (pool.length < count) {
                alert(`å‰©é¤˜äººæ•¸ (${pool.length}) ä¸è¶³ï¼Œç„¡æ³•æŠ½å‡º ${count} äºº`);
                return;
            }

            // é–å®š UI
            document.getElementById('btnStart').classList.add('hidden');
            document.getElementById('names').disabled = true;

            // æ´—ç‰Œç®—æ³• (Fisher-Yates)
            const shuffled = [...pool];
            for (let i = shuffled.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
            }

            const winners = shuffled.slice(0, count);

            if (mode === 'batch') {
                // ä¸€æ¬¡å…¨æŠ½æ¨¡å¼
                processBatchWinners(winners, prizeName);
                document.getElementById('btnStart').classList.remove('hidden');
                document.getElementById('names').disabled = false;
            } else {
                // ä¸€å€‹ä¸€å€‹æŠ½æ¨¡å¼
                singleModeQueue = winners;
                currentSinglePrize = prizeName;
                document.getElementById('btnNext').classList.remove('hidden');
                document.getElementById('currentDrawArea').classList.remove('hidden');
                document.getElementById('currentPrizeLabel').innerText = `æ­£åœ¨æŠ½å‡ºï¼š${prizeName}`;
                document.getElementById('bigWinnerDisplay').innerText = "æº–å‚™ä¸­...";
                
                // è‡ªå‹•è§¸ç™¼ç¬¬ä¸€æ¬¡
                // drawNext(); // å¦‚æœæƒ³è®“ç”¨æˆ¶è‡ªå·±æŒ‰ç¬¬ä¸€ä¸‹ï¼Œé€™è¡Œè¨»è§£æ‰
            }
        }

        function processBatchWinners(winners, prizeName) {
            winners.forEach(winner => {
                addWinnerCard(winner, prizeName);
                drawnNames.add(winner);
            });
            updateStats();
            fireConfetti();
        }

        function drawNext() {
            if (singleModeQueue.length === 0) {
                // çµæŸå–®æŠ½æ¨¡å¼
                finishSingleMode();
                return;
            }

            const btnNext = document.getElementById('btnNext');
            btnNext.disabled = true; // é˜²æ­¢é€£é»
            
            const winner = singleModeQueue.shift(); // å–å‡ºä¸‹ä¸€å€‹
            const display = document.getElementById('bigWinnerDisplay');

            // ç°¡å–®çš„æ»¾å‹•ç‰¹æ•ˆ
            let count = 0;
            const maxCount = 10; // æ»¾å‹•æ¬¡æ•¸
            const interval = setInterval(() => {
                // éš¨æ©Ÿé¡¯ç¤ºä¸€å€‹å‡åå­—è£½é€ ç·Šå¼µæ„Ÿ
                const tempPool = getPool();
                if(tempPool.length > 0) {
                    display.innerText = tempPool[Math.floor(Math.random() * tempPool.length)];
                }
                
                count++;
                if (count >= maxCount) {
                    clearInterval(interval);
                    // é¡¯ç¤ºçœŸæ­£å¾—ä¸»
                    display.innerText = winner;
                    addWinnerCard(winner, currentSinglePrize);
                    drawnNames.add(winner);
                    updateStats();
                    fireConfetti();
                    
                    btnNext.disabled = false;
                    
                    if (singleModeQueue.length === 0) {
                        btnNext.innerText = "å®Œæˆæœ¬è¼ª";
                    } else {
                        btnNext.innerText = `æŠ½ä¸‹ä¸€ä½ (å‰©é¤˜ ${singleModeQueue.length})`;
                    }
                }
            }, 50);
        }

        function finishSingleMode() {
            document.getElementById('btnStart').classList.remove('hidden');
            document.getElementById('btnNext').classList.add('hidden');
            document.getElementById('currentDrawArea').classList.add('hidden');
            document.getElementById('btnNext').innerText = "æŠ½ä¸‹ä¸€ä½";
            document.getElementById('names').disabled = false;
            singleModeQueue = [];
        }

        function addWinnerCard(name, prize) {
            const container = document.getElementById('winnerList');
            const card = document.createElement('div');
            card.className = 'winner-tag';
            card.innerHTML = `
                <span>${prize}</span>
                <div style="font-size: 1.2rem; font-weight: bold; color: var(--primary);">${name}</div>
            `;
            // æ’å…¥åˆ°æœ€å‰é¢
            container.insertBefore(card, container.firstChild);
        }

        function resetData() {
            if(!confirm("ç¢ºå®šè¦æ¸…é™¤æ‰€æœ‰å¾—çç´€éŒ„ä¸¦é‡ç½®å—ï¼Ÿ")) return;
            
            drawnNames.clear();
            document.getElementById('winnerList').innerHTML = '';
            document.getElementById('names').disabled = false;
            document.getElementById('btnStart').classList.remove('hidden');
            document.getElementById('btnNext').classList.add('hidden');
            document.getElementById('currentDrawArea').classList.add('hidden');
            updateStats();
        }

        function fireConfetti() {
            var duration = 3000;
            var animationEnd = Date.now() + duration;
            var defaults = { startVelocity: 30, spread: 360, ticks: 60, zIndex: 0 };

            var random = function(min, max) {
              return Math.random() * (max - min) + min;
            }

            var interval = setInterval(function() {
              var timeLeft = animationEnd - Date.now();

              if (timeLeft <= 0) {
                return clearInterval(interval);
              }

              var particleCount = 50 * (timeLeft / duration);
              // since particles fall down, start a bit higher than random
              confetti(Object.assign({}, defaults, { particleCount, origin: { x: random(0.1, 0.3), y: Math.random() - 0.2 } }));
              confetti(Object.assign({}, defaults, { particleCount, origin: { x: random(0.7, 0.9), y: Math.random() - 0.2 } }));
            }, 250);
        }

        // åˆå§‹åŒ–
        updateStats();
    </script>
</body>
</html>
